name: Finalize PvP Sync

# Trigger whenever the "PvP Sync Batch" workflow finishes on dev
on:
  workflow_run:
    workflows:
      - "PvP Sync Batch 1 / 1 for eu"
      - "PvP Sync Batch 2 / 2 for eu"
      - "PvP Sync Batch 3 / 3 for eu"
      - "PvP Sync Batch 4 / 4 for eu"
      - "PvP Sync Batch 5 / 5 for eu"
      - "PvP Sync Batch 6 / 6 for eu"
      - "PvP Sync Batch 7 / 7 for eu"
      - "PvP Sync Batch 8 / 8 for eu"
      - "PvP Sync Batch 9 / 9 for eu"
      - "PvP Sync Batch 10 / 10 for eu"
      - "PvP Sync Batch 11 / 11 for eu"
      - "PvP Sync Batch 12 / 12 for eu"
      - "PvP Sync Batch 13 / 13 for eu"
      - "PvP Sync Batch 14 / 14 for eu"
      - "PvP Sync Batch 15 / 15 for eu"
      - "PvP Sync Batch 16 / 16 for eu"
      - "PvP Sync Batch 17 / 17 for eu"
      - "PvP Sync Batch 18 / 18 for eu"
      - "PvP Sync Batch 19 / 19 for eu"
      - "PvP Sync Batch 20 / 20 for eu"
      - "PvP Sync Batch 21 / 21 for eu"
      - "PvP Sync Batch 22 / 22 for eu"
      - "PvP Sync Batch 23 / 23 for eu"
      - "PvP Sync Batch 24 / 24 for eu"
      - "PvP Sync Batch 25 / 25 for eu"
      - "PvP Sync Batch 26 / 26 for eu"
      - "PvP Sync Batch 27 / 27 for eu"
      - "PvP Sync Batch 28 / 28 for eu"
      - "PvP Sync Batch 29 / 29 for eu"
      - "PvP Sync Batch 30 / 30 for eu"
      - "PvP Sync Batch 31 / 31 for eu"
      - "PvP Sync Batch 32 / 32 for eu"
      - "PvP Sync Batch 33 / 33 for eu"
      - "PvP Sync Batch 34 / 34 for eu"
      - "PvP Sync Batch 35 / 35 for eu"
      - "PvP Sync Batch 36 / 36 for eu"
      - "PvP Sync Batch 37 / 37 for eu"
      - "PvP Sync Batch 38 / 38 for eu"
      - "PvP Sync Batch 39 / 39 for eu"
      - "PvP Sync Batch 40 / 40 for eu"
      - "PvP Sync Batch 41 / 41 for eu"
      - "PvP Sync Batch 42 / 42 for eu"
      - "PvP Sync Batch 43 / 43 for eu"
      - "PvP Sync Batch 44 / 44 for eu"
      - "PvP Sync Batch 45 / 45 for eu"
      - "PvP Sync Batch 46 / 46 for eu"
      - "PvP Sync Batch 47 / 47 for eu"
      - "PvP Sync Batch 48 / 48 for eu"
      - "PvP Sync Batch 49 / 49 for eu"
      - "PvP Sync Batch 50 / 50 for eu"
      - "PvP Sync Batch 51 / 51 for eu"
      - "PvP Sync Batch 52 / 52 for eu"
      - "PvP Sync Batch 53 / 53 for eu"
      - "PvP Sync Batch 54 / 54 for eu"
      - "PvP Sync Batch 55 / 55 for eu"
      - "PvP Sync Batch 56 / 56 for eu"
      - "PvP Sync Batch 57 / 57 for eu"
      - "PvP Sync Batch 58 / 58 for eu"
      - "PvP Sync Batch 59 / 59 for eu"
      - "PvP Sync Batch 60 / 60 for eu"
      - "PvP Sync Batch 61 / 61 for eu"
      - "PvP Sync Batch 62 / 62 for eu"
      - "PvP Sync Batch 63 / 63 for eu"
      - "PvP Sync Batch 64 / 64 for eu"
      - "PvP Sync Batch 65 / 65 for eu"
      - "PvP Sync Batch 66 / 66 for eu"
      - "PvP Sync Batch 67 / 67 for eu"
      - "PvP Sync Batch 68 / 68 for eu"
      - "PvP Sync Batch 69 / 69 for eu"
      - "PvP Sync Batch 70 / 70 for eu"
      - "PvP Sync Batch 71 / 71 for eu"
      - "PvP Sync Batch 72 / 72 for eu"
      - "PvP Sync Batch 73 / 73 for eu"
      - "PvP Sync Batch 74 / 74 for eu"
      - "PvP Sync Batch 75 / 75 for eu"
      - "PvP Sync Batch 76 / 76 for eu"
      - "PvP Sync Batch 77 / 77 for eu"
      - "PvP Sync Batch 78 / 78 for eu"
      - "PvP Sync Batch 79 / 79 for eu"
      - "PvP Sync Batch 80 / 80 for eu"
      - "PvP Sync Batch 81 / 81 for eu"
      - "PvP Sync Batch 82 / 82 for eu"
      - "PvP Sync Batch 83 / 83 for eu"
      - "PvP Sync Batch 84 / 84 for eu"
      - "PvP Sync Batch 85 / 85 for eu"
      - "PvP Sync Batch 86 / 86 for eu"
      - "PvP Sync Batch 87 / 87 for eu"
      - "PvP Sync Batch 88 / 88 for eu"
      - "PvP Sync Batch 89 / 89 for eu"
      - "PvP Sync Batch 90 / 90 for eu"
      - "PvP Sync Batch 91 / 91 for eu"
      - "PvP Sync Batch 92 / 92 for eu"
      - "PvP Sync Batch 93 / 93 for eu"
      - "PvP Sync Batch 94 / 94 for eu"
      - "PvP Sync Batch 95 / 95 for eu"
      - "PvP Sync Batch 96 / 96 for eu"
      - "PvP Sync Batch 97 / 97 for eu"
      - "PvP Sync Batch 98 / 98 for eu"
      - "PvP Sync Batch 99 / 99 for eu"
      - "PvP Sync Batch 100 / 100 for eu"
      - "PvP Sync Batch 1 / 1 for us"
      - "PvP Sync Batch 2 / 2 for us"
      - "PvP Sync Batch 3 / 3 for us"
      - "PvP Sync Batch 4 / 4 for us"
      - "PvP Sync Batch 5 / 5 for us"
      - "PvP Sync Batch 6 / 6 for us"
      - "PvP Sync Batch 7 / 7 for us"
      - "PvP Sync Batch 8 / 8 for us"
      - "PvP Sync Batch 9 / 9 for us"
      - "PvP Sync Batch 10 / 10 for us"
      - "PvP Sync Batch 11 / 11 for us"
      - "PvP Sync Batch 12 / 12 for us"
      - "PvP Sync Batch 13 / 13 for us"
      - "PvP Sync Batch 14 / 14 for us"
      - "PvP Sync Batch 15 / 15 for us"
      - "PvP Sync Batch 16 / 16 for us"
      - "PvP Sync Batch 17 / 17 for us"
      - "PvP Sync Batch 18 / 18 for us"
      - "PvP Sync Batch 19 / 19 for us"
      - "PvP Sync Batch 20 / 20 for us"
      - "PvP Sync Batch 21 / 21 for us"
      - "PvP Sync Batch 22 / 22 for us"
      - "PvP Sync Batch 23 / 23 for us"
      - "PvP Sync Batch 24 / 24 for us"
      - "PvP Sync Batch 25 / 25 for us"
      - "PvP Sync Batch 26 / 26 for us"
      - "PvP Sync Batch 27 / 27 for us"
      - "PvP Sync Batch 28 / 28 for us"
      - "PvP Sync Batch 29 / 29 for us"
      - "PvP Sync Batch 30 / 30 for us"
      - "PvP Sync Batch 31 / 31 for us"
      - "PvP Sync Batch 32 / 32 for us"
      - "PvP Sync Batch 33 / 33 for us"
      - "PvP Sync Batch 34 / 34 for us"
      - "PvP Sync Batch 35 / 35 for us"
      - "PvP Sync Batch 36 / 36 for us"
      - "PvP Sync Batch 37 / 37 for us"
      - "PvP Sync Batch 38 / 38 for us"
      - "PvP Sync Batch 39 / 39 for us"
      - "PvP Sync Batch 40 / 40 for us"
      - "PvP Sync Batch 41 / 41 for us"
      - "PvP Sync Batch 42 / 42 for us"
      - "PvP Sync Batch 43 / 43 for us"
      - "PvP Sync Batch 44 / 44 for us"
      - "PvP Sync Batch 45 / 45 for us"
      - "PvP Sync Batch 46 / 46 for us"
      - "PvP Sync Batch 47 / 47 for us"
      - "PvP Sync Batch 48 / 48 for us"
      - "PvP Sync Batch 49 / 49 for us"
      - "PvP Sync Batch 50 / 50 for us"
      - "PvP Sync Batch 51 / 51 for us"
      - "PvP Sync Batch 52 / 52 for us"
      - "PvP Sync Batch 53 / 53 for us"
      - "PvP Sync Batch 54 / 54 for us"
      - "PvP Sync Batch 55 / 55 for us"
      - "PvP Sync Batch 56 / 56 for us"
      - "PvP Sync Batch 57 / 57 for us"
      - "PvP Sync Batch 58 / 58 for us"
      - "PvP Sync Batch 59 / 59 for us"
      - "PvP Sync Batch 60 / 60 for us"
      - "PvP Sync Batch 61 / 61 for us"
      - "PvP Sync Batch 62 / 62 for us"
      - "PvP Sync Batch 63 / 63 for us"
      - "PvP Sync Batch 64 / 64 for us"
      - "PvP Sync Batch 65 / 65 for us"
      - "PvP Sync Batch 66 / 66 for us"
      - "PvP Sync Batch 67 / 67 for us"
      - "PvP Sync Batch 68 / 68 for us"
      - "PvP Sync Batch 69 / 69 for us"
      - "PvP Sync Batch 70 / 70 for us"
      - "PvP Sync Batch 71 / 71 for us"
      - "PvP Sync Batch 72 / 72 for us"
      - "PvP Sync Batch 73 / 73 for us"
      - "PvP Sync Batch 74 / 74 for us"
      - "PvP Sync Batch 75 / 75 for us"
      - "PvP Sync Batch 76 / 76 for us"
      - "PvP Sync Batch 77 / 77 for us"
      - "PvP Sync Batch 78 / 78 for us"
      - "PvP Sync Batch 79 / 79 for us"
      - "PvP Sync Batch 80 / 80 for us"
      - "PvP Sync Batch 81 / 81 for us"
      - "PvP Sync Batch 82 / 82 for us"
      - "PvP Sync Batch 83 / 83 for us"
      - "PvP Sync Batch 84 / 84 for us"
      - "PvP Sync Batch 85 / 85 for us"
      - "PvP Sync Batch 86 / 86 for us"
      - "PvP Sync Batch 87 / 87 for us"
      - "PvP Sync Batch 88 / 88 for us"
      - "PvP Sync Batch 89 / 89 for us"
      - "PvP Sync Batch 90 / 90 for us"
      - "PvP Sync Batch 91 / 91 for us"
      - "PvP Sync Batch 92 / 92 for us"
      - "PvP Sync Batch 93 / 93 for us"
      - "PvP Sync Batch 94 / 94 for us"
      - "PvP Sync Batch 95 / 95 for us"
      - "PvP Sync Batch 96 / 96 for us"
      - "PvP Sync Batch 97 / 97 for us"
      - "PvP Sync Batch 98 / 98 for us"
      - "PvP Sync Batch 99 / 99 for us"
      - "PvP Sync Batch 100 / 100 for us"
      - "PvP Sync Batch 1 / 1 for tw"
      - "PvP Sync Batch 2 / 2 for tw"
      - "PvP Sync Batch 3 / 3 for tw"
      - "PvP Sync Batch 4 / 4 for tw"
      - "PvP Sync Batch 5 / 5 for tw"
      - "PvP Sync Batch 6 / 6 for tw"
      - "PvP Sync Batch 7 / 7 for tw"
      - "PvP Sync Batch 8 / 8 for tw"
      - "PvP Sync Batch 9 / 9 for tw"
      - "PvP Sync Batch 10 / 10 for tw"
      - "PvP Sync Batch 11 / 11 for tw"
      - "PvP Sync Batch 12 / 12 for tw"
      - "PvP Sync Batch 13 / 13 for tw"
      - "PvP Sync Batch 14 / 14 for tw"
      - "PvP Sync Batch 15 / 15 for tw"
      - "PvP Sync Batch 16 / 16 for tw"
      - "PvP Sync Batch 17 / 17 for tw"
      - "PvP Sync Batch 18 / 18 for tw"
      - "PvP Sync Batch 19 / 19 for tw"
      - "PvP Sync Batch 20 / 20 for tw"
      - "PvP Sync Batch 21 / 21 for tw"
      - "PvP Sync Batch 22 / 22 for tw"
      - "PvP Sync Batch 23 / 23 for tw"
      - "PvP Sync Batch 24 / 24 for tw"
      - "PvP Sync Batch 25 / 25 for tw"
      - "PvP Sync Batch 26 / 26 for tw"
      - "PvP Sync Batch 27 / 27 for tw"
      - "PvP Sync Batch 28 / 28 for tw"
      - "PvP Sync Batch 29 / 29 for tw"
      - "PvP Sync Batch 30 / 30 for tw"
      - "PvP Sync Batch 31 / 31 for tw"
      - "PvP Sync Batch 32 / 32 for tw"
      - "PvP Sync Batch 33 / 33 for tw"
      - "PvP Sync Batch 34 / 34 for tw"
      - "PvP Sync Batch 35 / 35 for tw"
      - "PvP Sync Batch 36 / 36 for tw"
      - "PvP Sync Batch 37 / 37 for tw"
      - "PvP Sync Batch 38 / 38 for tw"
      - "PvP Sync Batch 39 / 39 for tw"
      - "PvP Sync Batch 40 / 40 for tw"
      - "PvP Sync Batch 41 / 41 for tw"
      - "PvP Sync Batch 42 / 42 for tw"
      - "PvP Sync Batch 43 / 43 for tw"
      - "PvP Sync Batch 44 / 44 for tw"
      - "PvP Sync Batch 45 / 45 for tw"
      - "PvP Sync Batch 46 / 46 for tw"
      - "PvP Sync Batch 47 / 47 for tw"
      - "PvP Sync Batch 48 / 48 for tw"
      - "PvP Sync Batch 49 / 49 for tw"
      - "PvP Sync Batch 50 / 50 for tw"
      - "PvP Sync Batch 51 / 51 for tw"
      - "PvP Sync Batch 52 / 52 for tw"
      - "PvP Sync Batch 53 / 53 for tw"
      - "PvP Sync Batch 54 / 54 for tw"
      - "PvP Sync Batch 55 / 55 for tw"
      - "PvP Sync Batch 56 / 56 for tw"
      - "PvP Sync Batch 57 / 57 for tw"
      - "PvP Sync Batch 58 / 58 for tw"
      - "PvP Sync Batch 59 / 59 for tw"
      - "PvP Sync Batch 60 / 60 for tw"
      - "PvP Sync Batch 61 / 61 for tw"
      - "PvP Sync Batch 62 / 62 for tw"
      - "PvP Sync Batch 63 / 63 for tw"
      - "PvP Sync Batch 64 / 64 for tw"
      - "PvP Sync Batch 65 / 65 for tw"
      - "PvP Sync Batch 66 / 66 for tw"
      - "PvP Sync Batch 67 / 67 for tw"
      - "PvP Sync Batch 68 / 68 for tw"
      - "PvP Sync Batch 69 / 69 for tw"
      - "PvP Sync Batch 70 / 70 for tw"
      - "PvP Sync Batch 71 / 71 for tw"
      - "PvP Sync Batch 72 / 72 for tw"
      - "PvP Sync Batch 73 / 73 for tw"
      - "PvP Sync Batch 74 / 74 for tw"
      - "PvP Sync Batch 75 / 75 for tw"
      - "PvP Sync Batch 76 / 76 for tw"
      - "PvP Sync Batch 77 / 77 for tw"
      - "PvP Sync Batch 78 / 78 for tw"
      - "PvP Sync Batch 79 / 79 for tw"
      - "PvP Sync Batch 80 / 80 for tw"
      - "PvP Sync Batch 81 / 81 for tw"
      - "PvP Sync Batch 82 / 82 for tw"
      - "PvP Sync Batch 83 / 83 for tw"
      - "PvP Sync Batch 84 / 84 for tw"
      - "PvP Sync Batch 85 / 85 for tw"
      - "PvP Sync Batch 86 / 86 for tw"
      - "PvP Sync Batch 87 / 87 for tw"
      - "PvP Sync Batch 88 / 88 for tw"
      - "PvP Sync Batch 89 / 89 for tw"
      - "PvP Sync Batch 90 / 90 for tw"
      - "PvP Sync Batch 91 / 91 for tw"
      - "PvP Sync Batch 92 / 92 for tw"
      - "PvP Sync Batch 93 / 93 for tw"
      - "PvP Sync Batch 94 / 94 for tw"
      - "PvP Sync Batch 95 / 95 for tw"
      - "PvP Sync Batch 96 / 96 for tw"
      - "PvP Sync Batch 97 / 97 for tw"
      - "PvP Sync Batch 98 / 98 for tw"
      - "PvP Sync Batch 99 / 99 for tw"
      - "PvP Sync Batch 100 / 100 for tw"
      - "PvP Sync Batch 1 / 1 for kr"
      - "PvP Sync Batch 2 / 2 for kr"
      - "PvP Sync Batch 3 / 3 for kr"
      - "PvP Sync Batch 4 / 4 for kr"
      - "PvP Sync Batch 5 / 5 for kr"
      - "PvP Sync Batch 6 / 6 for kr"
      - "PvP Sync Batch 7 / 7 for kr"
      - "PvP Sync Batch 8 / 8 for kr"
      - "PvP Sync Batch 9 / 9 for kr"
      - "PvP Sync Batch 10 / 10 for kr"
      - "PvP Sync Batch 11 / 11 for kr"
      - "PvP Sync Batch 12 / 12 for kr"
      - "PvP Sync Batch 13 / 13 for kr"
      - "PvP Sync Batch 14 / 14 for kr"
      - "PvP Sync Batch 15 / 15 for kr"
      - "PvP Sync Batch 16 / 16 for kr"
      - "PvP Sync Batch 17 / 17 for kr"
      - "PvP Sync Batch 18 / 18 for kr"
      - "PvP Sync Batch 19 / 19 for kr"
      - "PvP Sync Batch 20 / 20 for kr"
      - "PvP Sync Batch 21 / 21 for kr"
      - "PvP Sync Batch 22 / 22 for kr"
      - "PvP Sync Batch 23 / 23 for kr"
      - "PvP Sync Batch 24 / 24 for kr"
      - "PvP Sync Batch 25 / 25 for kr"
      - "PvP Sync Batch 26 / 26 for kr"
      - "PvP Sync Batch 27 / 27 for kr"
      - "PvP Sync Batch 28 / 28 for kr"
      - "PvP Sync Batch 29 / 29 for kr"
      - "PvP Sync Batch 30 / 30 for kr"
      - "PvP Sync Batch 31 / 31 for kr"
      - "PvP Sync Batch 32 / 32 for kr"
      - "PvP Sync Batch 33 / 33 for kr"
      - "PvP Sync Batch 34 / 34 for kr"
      - "PvP Sync Batch 35 / 35 for kr"
      - "PvP Sync Batch 36 / 36 for kr"
      - "PvP Sync Batch 37 / 37 for kr"
      - "PvP Sync Batch 38 / 38 for kr"
      - "PvP Sync Batch 39 / 39 for kr"
      - "PvP Sync Batch 40 / 40 for kr"
      - "PvP Sync Batch 41 / 41 for kr"
      - "PvP Sync Batch 42 / 42 for kr"
      - "PvP Sync Batch 43 / 43 for kr"
      - "PvP Sync Batch 44 / 44 for kr"
      - "PvP Sync Batch 45 / 45 for kr"
      - "PvP Sync Batch 46 / 46 for kr"
      - "PvP Sync Batch 47 / 47 for kr"
      - "PvP Sync Batch 48 / 48 for kr"
      - "PvP Sync Batch 49 / 49 for kr"
      - "PvP Sync Batch 50 / 50 for kr"
      - "PvP Sync Batch 51 / 51 for kr"
      - "PvP Sync Batch 52 / 52 for kr"
      - "PvP Sync Batch 53 / 53 for kr"
      - "PvP Sync Batch 54 / 54 for kr"
      - "PvP Sync Batch 55 / 55 for kr"
      - "PvP Sync Batch 56 / 56 for kr"
      - "PvP Sync Batch 57 / 57 for kr"
      - "PvP Sync Batch 58 / 58 for kr"
      - "PvP Sync Batch 59 / 59 for kr"
      - "PvP Sync Batch 60 / 60 for kr"
      - "PvP Sync Batch 61 / 61 for kr"
      - "PvP Sync Batch 62 / 62 for kr"
      - "PvP Sync Batch 63 / 63 for kr"
      - "PvP Sync Batch 64 / 64 for kr"
      - "PvP Sync Batch 65 / 65 for kr"
      - "PvP Sync Batch 66 / 66 for kr"
      - "PvP Sync Batch 67 / 67 for kr"
      - "PvP Sync Batch 68 / 68 for kr"
      - "PvP Sync Batch 69 / 69 for kr"
      - "PvP Sync Batch 70 / 70 for kr"
      - "PvP Sync Batch 71 / 71 for kr"
      - "PvP Sync Batch 72 / 72 for kr"
      - "PvP Sync Batch 73 / 73 for kr"
      - "PvP Sync Batch 74 / 74 for kr"
      - "PvP Sync Batch 75 / 75 for kr"
      - "PvP Sync Batch 76 / 76 for kr"
      - "PvP Sync Batch 77 / 77 for kr"
      - "PvP Sync Batch 78 / 78 for kr"
      - "PvP Sync Batch 79 / 79 for kr"
      - "PvP Sync Batch 80 / 80 for kr"
      - "PvP Sync Batch 81 / 81 for kr"
      - "PvP Sync Batch 82 / 82 for kr"
      - "PvP Sync Batch 83 / 83 for kr"
      - "PvP Sync Batch 84 / 84 for kr"
      - "PvP Sync Batch 85 / 85 for kr"
      - "PvP Sync Batch 86 / 86 for kr"
      - "PvP Sync Batch 87 / 87 for kr"
      - "PvP Sync Batch 88 / 88 for kr"
      - "PvP Sync Batch 89 / 89 for kr"
      - "PvP Sync Batch 90 / 90 for kr"
      - "PvP Sync Batch 91 / 91 for kr"
      - "PvP Sync Batch 92 / 92 for kr"
      - "PvP Sync Batch 93 / 93 for kr"
      - "PvP Sync Batch 94 / 94 for kr"
      - "PvP Sync Batch 95 / 95 for kr"
      - "PvP Sync Batch 96 / 96 for kr"
      - "PvP Sync Batch 97 / 97 for kr"
      - "PvP Sync Batch 98 / 98 for kr"
      - "PvP Sync Batch 99 / 99 for kr"
      - "PvP Sync Batch 100 / 100 for kr"
    types: [completed]
    branches: [dev]

permissions:
  contents: write
  actions: read

concurrency:
  group: finalize-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  guard:
    name: Check if this was the last batch
    runs-on: ubuntu-latest
    outputs:
      is_final: ${{ steps.parse.outputs.is_final }}
      region:   ${{ steps.parse.outputs.region }}
      # only run on PvP Sync Batch runs
      if: ${{ github.event.workflow_run.name == 'PvP Sync Batch' }}
    steps:
      - name: Parse batch number & region from run title
        id: parse
        shell: bash
        run: |
          set -euo pipefail
          TITLE="${{ github.event.workflow_run.display_title }}"
          echo "Run title: $TITLE"
          # Expect titles like: "PvP Sync Batch 3 / 10 for kr"
          if [[ "$TITLE" =~ ^PvP[[:space:]]Sync[[:space:]]Batch[[:space:]]([0-9]+)[[:space:]]*/[[:space:]]*([0-9]+)[[:space:]]for[[:space:]]([a-z]{2})$ ]]; then
            CUR="${BASH_REMATCH[1]}"
            TOT="${BASH_REMATCH[2]}"
            REGION="${BASH_REMATCH[3]}"
            echo "region=$REGION" >>"$GITHUB_OUTPUT"
            if [[ "$CUR" == "$TOT" ]]; then
              echo "is_final=true" >>"$GITHUB_OUTPUT"
              echo "✅ Detected final batch ($CUR/$TOT) for $REGION"
            else
              echo "is_final=false" >>"$GITHUB_OUTPUT"
              echo "⏭ Not final batch ($CUR/$TOT) for $REGION → skipping finalize."
            fi
          else
            echo "is_final=false" >>"$GITHUB_OUTPUT"
            echo "⚠️ Couldn't parse batch info; aborting finalize."
          fi

  finalize:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      needs.guard.outputs.is_final == 'true'
    needs: guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Wait for ALL region batch runs to complete
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          wf="PvP Sync Batch"
          region="${{ needs.guard.outputs.region }}"
          sha="${{ github.event.workflow_run.head_sha }}"
          branch="${{ github.event.workflow_run.head_branch }}"
          echo "Waiting for all '$wf' runs for region=$region, sha=$sha..."
          while true; do
            # find any runs still pending/running for this sha+region
            rem=$(gh run list \
                  -w "$wf" -b "$branch" -L 500 \
                  --json status,displayTitle,headSha \
                  --jq "[ .[]
                          | select(.headSha==\"$sha\")
                          | select(.displayTitle|endswith(\" for $region\"))
                          | select(.status!=\"completed\") ] | length")
            if (( rem == 0 )); then
              echo "✅ All $wf runs for $region/$sha are done."
              break
            fi
            echo "⏳ $rem runs still in progress…"
            sleep 10
          done

      - name: Download every batch’s DB shard
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          wf="PvP Sync Batch"
          region="${{ needs.guard.outputs.region }}"
          sha="${{ github.event.workflow_run.head_sha }}"
          branch="${{ github.event.workflow_run.head_branch }}"
          mkdir -p partial_outputs
          # grab the list of run IDs for this sha+region
          ids=$(gh run list \
                  -w "$wf" -b "$branch" -L 500 \
                  --json databaseId,displayTitle,headSha \
                  --jq "[ .[]
                            | select(.headSha==\"$sha\")
                            | select(.displayTitle|endswith(\" for $region\"))
                            | .databaseId ] | unique | .[]")
          for id in $ids; do
            echo "Downloading DB shard from run $id…"
            gh run download "$id" \
               --pattern "achiev_${region}.db" \
               -D partial_outputs || true
          done

      - name: Finalize region file
        env:
          REGION: ${{ needs.guard.outputs.region }}
          BLIZZARD_CLIENT_ID:     ${{ secrets.BLIZZARD_CLIENT_ID }}
          BLIZZARD_CLIENT_SECRET: ${{ secrets.BLIZZARD_CLIENT_SECRET }}
          BLIZZARD_CLIENT_ID_EU:     ${{ secrets.BLIZZARD_CLIENT_ID_EU }}
          BLIZZARD_CLIENT_SECRET_EU: ${{ secrets.BLIZZARD_CLIENT_SECRET_EU }}
          BLIZZARD_CLIENT_ID_US:     ${{ secrets.BLIZZARD_CLIENT_ID_US }}
          BLIZZARD_CLIENT_SECRET_US: ${{ secrets.BLIZZARD_CLIENT_SECRET_US }}
        run: |
          set -euo pipefail
          echo "Merging batches and writing final region_${REGION}.lua…"
          python sync_pvp.py --mode finalize --region "$REGION"

      - name: Commit & push finalized .lua
        run: |
          git config user.name  "GitHub Action"
          git config user.email "action@github.com"
          git add region_${{ needs.guard.outputs.region }}.lua
          git commit -m "Finalize PvP sync for ${{ needs.guard.outputs.region }}" \
            || echo "No changes to commit"
          git push origin dev
