name: PvP Sync Batch
run-name: PvP Sync for ${{ inputs.region }} ${{ inputs.batch_id }} / ${{ inputs.total_batches }} / (group ${{ inputs['group-id'] }})

on:
  workflow_call:
    inputs:
      batch_id:
        required: true
        type: string
      total_batches:
        required: true
        type: string
      region:
        required: true
        type: string
      offset:
        required: true
        type: string
      limit:
        required: true
        type: string
      group-id:
        required: false
        type: string
        
  workflow_dispatch:                       # so we can `createWorkflowDispatch` via API
    inputs:
      region:
        description: 'us, eu, kr, tw'
        required: true
        type: string
      offset:
        description: 'list offset'
        required: true
        type: string
      limit:
        description: 'batch size'
        required: true
        type: string
      batch_id:
        description: '0-based batch index'
        required: true
        type: string
      total_batches:
        description: 'Total number of batches'
        required: true
        type: string
      group-id:
        description: 'Dispatcher run id used to correlate this batch'
        required: true
        type: string
        
jobs:
  batch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Set up Python
        uses: actions/setup-python@v5
        with: { python-version: '3.13' }
      - name: Install deps
        run: |
          pip install aiohttp requests psutil
      - name: Run PvP Sync batch
        env:
          REGION: ${{ inputs.region }}
          BATCH_SIZE: ${{ inputs.limit }}
          BLIZZARD_CLIENT_ID:        ${{ secrets.BLIZZARD_CLIENT_ID }}
          BLIZZARD_CLIENT_SECRET:    ${{ secrets.BLIZZARD_CLIENT_SECRET }}
          BLIZZARD_CLIENT_ID_EU:     ${{ secrets.BLIZZARD_CLIENT_ID_EU }}
          BLIZZARD_CLIENT_SECRET_EU: ${{ secrets.BLIZZARD_CLIENT_SECRET_EU }}
          BLIZZARD_CLIENT_ID_US:     ${{ secrets.BLIZZARD_CLIENT_ID_US }}
          BLIZZARD_CLIENT_SECRET_US: ${{ secrets.BLIZZARD_CLIENT_SECRET_US }}
        run: |
          python sync_pvp.py \
            --mode batch \
            --region "${{ inputs.region }}" \
            --batch-id ${{ inputs.batch_id }} \
            --total-batches ${{ inputs.total_batches }} \
            --offset ${{ inputs.offset }} \
            --limit ${{ inputs.limit }}

      - name: Upload partial Lua
        uses: actions/upload-artifact@v4
        with:
          name: pvp-partial-${{ inputs.region }}-batch-${{ inputs.batch_id }}-group-${{ inputs['group-id'] }}
          path: partial_outputs/${{ inputs.region }}_batch_${{ inputs.batch_id }}.lua
          if-no-files-found: error
          retention-days: 7

      - name: Upload DB shard
        uses: actions/upload-artifact@v4
        with:
          name: pvp-db-${{ inputs.region }}-batch-${{ inputs.batch_id }}-group-${{ inputs['group-id'] }}
          path: partial_outputs/achdb_${{ inputs.region }}_b${{ inputs.batch_id }}.sqlite
          if-no-files-found: error
          retention-days: 7
