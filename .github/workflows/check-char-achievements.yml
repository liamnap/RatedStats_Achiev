name: Check PvP Achievements for Character
run-name: Checking PvP Achievements for ${{ inputs.character_realm }}

permissions:
  contents: read
  actions: read

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Region code'
        required: true
        type: choice
        default: 'eu'
        options:
          - us
          - eu
          - kr
          - tw
      character_realm:
        description: 'Character name-realm (e.g., MyChar-MyRealm)'
        required: true
        default: ''
      check_alts:
        description: 'Also scan merged DB for alt candidates?'
        required: true
        type: boolean
        default: false

jobs:
  check-character:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp requests

      - name: Download latest merged DB for region
        env:
          GH_TOKEN: ${{ github.token }}
          REGION: ${{ inputs.region }}
        run: |
          set -euo pipefail

          region="${REGION}"
          wf="Finalize PvP Sync"
          branch="dev"
          repo="${GITHUB_REPOSITORY:-${{ github.repository }}}"

          echo "Looking for latest successful '${wf}' run on ${branch} for region=${region}..."
          run_id="$(gh run list \
            --workflow "$wf" \
            --branch "$branch" \
            --status success \
            --json databaseId,displayTitle \
            --jq '[ .[] | select(.displayTitle | endswith(" for '"$region"'")) ][0].databaseId' || true)"

          if [[ -z "$run_id" ]]; then
            echo "⚠️ No successful '${wf}' run found for region=${region} on branch=${branch}"
            exit 0
          fi

          # Adjust this name to whatever you used in the finalizer upload step
          art_name="$(gh api repos/"$repo"/actions/runs/"$run_id"/artifacts \
            --jq '.artifacts[].name | select(startswith("pvp-merged-'"$region"'"))' | head -n1 || true)"

          if [[ -z "$art_name" ]]; then
            echo "⚠️ No merged DB artifact found for run_id=${run_id} region=${region}"
            exit 0
          fi

          echo "Downloading artifact '${art_name}' from run_id=${run_id}..."
          gh run download "$run_id" --name "$art_name" --dir .

          db_path="$(find . -maxdepth 5 -type f -name "achiev_${region}.db" | head -n1 || true)"
          if [[ -z "$db_path" ]]; then
            echo "⚠️ Downloaded artifact but could not locate achiev_${region}.db"
            find . -maxdepth 5 -type f -print
            exit 0
          fi

          # If the artifact already unpacked to ./achiev_<region>.db, don't try to move it
          if [[ "$db_path" != "./achiev_${region}.db" ]]; then
            mv "$db_path" "./achiev_${region}.db"
          else
            echo "Found merged DB already at ./achiev_${region}.db; no move needed."
          fi
          
          echo "MERGED_DB_PATH=./achiev_${region}.db" >> "$GITHUB_ENV"

      - name: Run character achievement check
        env:
          REGION: ${{ inputs.region }}
          CHARACTER_REALM: ${{ inputs.character_realm }}
          CHAR_PVP_ACHIEVEMENTS_ID: ${{ secrets.CHAR_PVP_ACHIEVEMENTS_ID }}
          CHAR_PVP_ACHIEVEMENTS_SECRET: ${{ secrets.CHAR_PVP_ACHIEVEMENTS_SECRET }}
          CHECK_ALTS: ${{ inputs.check_alts }}
        run: |
          python ./check_character_pvp.py \
            --region "$REGION" \
            --character-realm "$CHARACTER_REALM" \
            $( [ "$CHECK_ALTS" = "true" ] && echo "--check-alts" || true )
