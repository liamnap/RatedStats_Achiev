name: Daily PvP Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      matrix:
        include:
          # Generate combinations of 0-99 batches per region
          # Can be generated programmatically offline to avoid 400 manual entries
          {% for region in ['us', 'eu', 'kr', 'tw'] %}
          {% for batch in range(0, 100) %}
          - region: {{ region }}
            batch: {{ batch }}
          {% endfor %}
          {% endfor %}

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp requests psutil

      - name: Run Batch Sync
        env:
          BLIZZARD_CLIENT_ID:     ${{ secrets.BLIZZARD_CLIENT_ID }}
          BLIZZARD_CLIENT_SECRET: ${{ secrets.BLIZZARD_CLIENT_SECRET }}
          BLIZZARD_CLIENT_ID_EU:     ${{ secrets.BLIZZARD_CLIENT_ID_EU }}
          BLIZZARD_CLIENT_SECRET_EU: ${{ secrets.BLIZZARD_CLIENT_SECRET_EU }}
          BLIZZARD_CLIENT_ID_US:     ${{ secrets.BLIZZARD_CLIENT_ID_US }}
          BLIZZARD_CLIENT_SECRET_US: ${{ secrets.BLIZZARD_CLIENT_SECRET_US }}
          REGION: ${{ matrix.region }}
          BATCH: ${{ matrix.batch }}
        run: |
          python sync_pvp.py --region "$REGION" --batch "$BATCH"

      - name: Upload partial results
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: partial-${{ matrix.region }}
          path: achiev/region_${{ matrix.region }}.lua
          if-no-files-found: ignore

  finalize:
    needs: sync
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region: [us, eu, kr, tw]

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download region partials
        uses: actions/download-artifact@v4
        with:
          name: partial-${{ matrix.region }}
          path: achiev/

      - name: Commit merged results
        run: |
          git config user.name  "GitHub Action"
          git config user.email "action@github.com"
          git add achiev/region_${{ matrix.region }}.lua
          git commit -m "PvP sync update for ${{ matrix.region }}" || echo "No changes to commit"
          git fetch origin dev
          git rebase origin/dev
          git push --force-with-lease origin dev
